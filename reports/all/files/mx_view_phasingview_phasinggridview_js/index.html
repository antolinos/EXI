<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - mx/view/phasingview/phasinggridview.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>mx/view/phasingview/phasinggridview.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">102.36</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">255</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">46.31</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.64</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
* Displays the phasing grid
*
function PhasingGridView(args) {
* @class MXDataCollectionGrid
* @constructor
*/
function PhasingGridView(args) {
    this.hasScroll = true;
    if (args) {
        if (args.hasScroll != null) {
            this.hasScroll = args.hasScroll;
        }
    }
}

PhasingGridView.prototype.load = function(dataCollectionGroupId, PhasingStep_method) {
    this.dataCollectionGroupId = dataCollectionGroupId;
    this.PhasingStep_method = PhasingStep_method;
}

PhasingGridView.prototype.printHTML = function(target) {
    var _this = this;
    
    var onSuccess = function(sender, data){        
        /** It filters all phasing step which method is _this.PhasingStep_method: [SAD | MR]  */
       data[0] = _.filter(data[0], {PhasingStep_method : _this.PhasingStep_method})
    
       /** It gets all space groups */
       var spaceGroups = _.keyBy(data[0], &quot;SpaceGroup_spaceGroupShortName&quot;);
       
       var parsed = [];

       /** Loop by space group in order to make a summary */
       for(var spaceGroup in spaceGroups){           
           if (spaceGroup != &quot;null&quot;){

               /** It gets all steps for the same space group */
               var stepsBySpaceGroup = _.filter(data[0],{&quot;SpaceGroup_spaceGroupShortName&quot;: spaceGroup});

               function getStepId(stepsBySpaceGroup){
                   return _.keys(_.keyBy(stepsBySpaceGroup, &quot;PhasingStep_phasingStepId&quot;)).toString();
               }

               function getCSV(stepsBySpaceGroup){
                   var keys = _.keys(_.keyBy(stepsBySpaceGroup, &quot;csv&quot;));
                   return _.filter(keys, function(e){return e!= &quot;null&quot;;});
               }
           
               /** node contains all steps for the same space group organized by step type */
               var node = {};
               
               /** Node to be displayed for MR. It has got two steps: [PHASING, REFINEMENT]*/
               if (_this.PhasingStep_method == &quot;MR&quot;){
                    node = ({
                        spaceGroup       : spaceGroup,                                    
                        hasPhasing          : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;PHASING&quot;}) != null,
                        hasRefinement       : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;REFINEMENT&quot;}) != null,                
                        downloadCSV      : EXI.getDataAdapter().mx.phasing.getCSVPhasingFilesByPhasingAttachmentIdURL(getCSV(stepsBySpaceGroup)),
                        downloadFilesUrl : EXI.getDataAdapter().mx.phasing.getDownloadFilesByPhasingStepIdURL(getStepId(stepsBySpaceGroup))
                        
                    });

               }
               else{
                    /** Node to be displayed for Phasing that contains several steps: [PREPARE, SUBSTRUCTUREDETERMINATION, PHASING, MODELBUILDING] */
                    node = ({
                        spaceGroup          : spaceGroup,
                        hasPrepare          : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;PREPARE&quot;}) != null,
                        hasSub              : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;SUBSTRUCTUREDETERMINATION&quot;}) != null,
                        hasPhasing          : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;PHASING&quot;}) != null,                    
                        hasModel            : _.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;MODELBUILDING&quot;}) != null,
                        downloadCSV         : EXI.getDataAdapter().mx.phasing.getCSVPhasingFilesByPhasingAttachmentIdURL(getCSV(stepsBySpaceGroup)),
                        downloadFilesUrl    : EXI.getDataAdapter().mx.phasing.getDownloadFilesByPhasingStepIdURL(getStepId(stepsBySpaceGroup))
                        
                    });
               }
               

               /**
                * This funcitons adds the metrics into the dicctionary and also the PNG
                */
               function getMetrics(phasingStep){                                                         
                    if (phasingStep.metric){                        
                            var singleMetric = phasingStep.metric.split(&quot;,&quot;);
                            var values = phasingStep.statisticsValue.split(&quot;,&quot;);                            
                            for (var j = 0; j &lt; singleMetric.length; j++) {   
                                    /* Spaces are replaced by _ to be used on the templates */                        
                                    phasingStep[singleMetric[j].replace(/ /g, &#039;_&#039;)] = values[j];                           
                            }
                    } 
                    if (phasingStep.png){                        
                        /** It might happens that there are two PDB like:&quot;159386,159388&quot; */
                        phasingStep.png = phasingStep.png.split(&quot;,&quot;)[0];                        
                        phasingStep.pngURL = EXI.getDataAdapter().mx.phasing.getPhasingFilesByPhasingProgramAttachmentIdAsImage(phasingStep.png);
                    }                                        
                    phasingStep.spaceGroup = phasingStep.SpaceGroup_spaceGroupShortName; 
                    return (phasingStep);                     
               }
                              

               /**
                * This functions add to toBepush the URL for every fileType found
                    fileTypesField = CCALL_CCWEAK,OCCUPANCY_SITENUMBER
                    phasingProgramAttachmentFields = XXXX, YYYYY

                */
               function parseFilteTypes(fileTypesField, phasingProgramAttachmentFields, toBePushed){
                        if (fileTypesField != null){                                
                            var types = fileTypesField.split(&quot;,&quot;);
                            var ids = phasingProgramAttachmentFields.split(&quot;,&quot;);                                                        
                            for (var r = 0; r &lt; types.length; r++) {
                                toBePushed[types[r]] = EXI.getDataAdapter().mx.phasing.getPhasingFilesByPhasingProgramAttachmentIdAsImage(ids[r]);
                            }                                                            
                        }
               }

                function parseDownloadAttachments(leaf){
                       var fileAttachmentsId = [];
                       while (leaf != null){                             
                                fileAttachmentsId.push(leaf.PhasingStep_phasingStepId);
                                leaf = _.find(stepsBySpaceGroup, {&#039;PhasingStep_phasingStepId&#039;:leaf.PhasingStep_previousPhasingStepId});
                       }
                       return fileAttachmentsId;
               }

               function getNodeByPhasingStep(node, stepsBySpaceGroup, step){                                      
                   var steps = _.filter(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : step});
                   node[&quot;metrics&quot;] = [];
                   if (steps){                       
                       var metrics = _.map(steps, &quot;metric&quot;);
                       var statisticsValues = _.map(steps, &quot;statisticsValue&quot;);
                       for (var z=0; z &lt; steps.length; z++){   
                            var toBePushed =  steps[z];
                            
                            /**
                             * This adds the phasing plots into the dictionary looking for them from the previous steps
                             */
                            var leaf = steps[z];                           
                            while (leaf != null){                             
                                parseFilteTypes(leaf.fileType, leaf.phasingProgramAttachmentId, toBePushed);
                                leaf = _.find(stepsBySpaceGroup, {&#039;PhasingStep_phasingStepId&#039;:leaf.PhasingStep_previousPhasingStepId});
                            }
                            
                            if (steps[z].metric){                                                        
                                toBePushed = getMetrics(steps[z]);
                            }  
                            
                            /* Opening uglymol with:
                                    1) pdb file
                                    2) map1 as first map file
                                    3) map2 as second map file
                                    */           
                            var pdbUrl = EXI.getDataAdapter().mx.phasing.downloadPhasingFilesByPhasingAttachmentId( steps[z].pdb);                            
                           
                            if ( steps[0].map != null){
                                var mapsArr = steps[z].map.split(&quot;,&quot;);
                                if (mapsArr.length == 2){
                                    var mapUrl1 = EXI.getDataAdapter().mx.phasing.downloadPhasingFilesByPhasingAttachmentId( mapsArr[0]);
                                    var mapUrl2 = EXI.getDataAdapter().mx.phasing.downloadPhasingFilesByPhasingAttachmentId( mapsArr[1]);                                
                                    toBePushed[&quot;uglymol&quot;] = &#039;../viewer/uglymol/index.html?pdb=&#039; + pdbUrl + &#039;&amp;map1=&#039; + mapUrl1 + &#039;&amp;map2=&#039; + mapUrl2;
                                }
                            }  
                            /** It will add only the files coming from these steps */
                            toBePushed[&quot;downloadFilesUrl&quot;] = EXI.getDataAdapter().mx.phasing.getDownloadFilesByPhasingStepIdURL(parseDownloadAttachments(steps[z]));                                                                            
                            node[&quot;metrics&quot;].push(toBePushed);                         
                       }                                            
                   }     
                   node[&quot;phasingStepId&quot;] = steps[0].PhasingStep_phasingStepId;
                   return node;         
               }
               
               /**
                StepS for Phasing are: PREPARE,  SUBSTRUCTUREDETERMINATION, PHASING AND MODELBUILDING
                StepS for Molecular replacement are: PHASING AND REFINEMENT */

               /** If there is model building then we will display modelbuilding */
               if (_.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;MODELBUILDING&quot;}) != null){
                        node = getNodeByPhasingStep(node, stepsBySpaceGroup, &quot;MODELBUILDING&quot;);
               }
               else{
                   /** There is no model building the we parse the phasing*/
                    if (_.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;PHASING&quot;}) != null){
                       node = getNodeByPhasingStep(node, stepsBySpaceGroup, &quot;PHASING&quot;);
                    }
                    else{
                        if (_.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;SUBSTRUCTUREDETERMINATION&quot;}) != null){ 
                            node = getNodeByPhasingStep(node, stepsBySpaceGroup, &quot;SUBSTRUCTUREDETERMINATION&quot;); 
                        }
                        else{                            
                             if (_.find(stepsBySpaceGroup, {&quot;PhasingStep_phasingStepType&quot; : &quot;REFINEMENT&quot;}) != null){                                  
                                 node = getNodeByPhasingStep(node, stepsBySpaceGroup, &quot;REFINEMENT&quot;);                                  
                             }
                             else{
                                 node = getNodeByPhasingStep(node, stepsBySpaceGroup, &quot;PREPARE&quot;);        
                            }
                        }
                    }
               }
               
               /** This will be used to sort */
               var count = 0;
               if (node.hasPrepare){
                   count = count + 1;
               }
               if (node.hasSub){
                   count = count + 1;
               }
               if (node.hasPhasing){
                   count = count + 1;
               }
               if (node.hasModel){
                   count = count + 1;
               }
                if (node.hasRefinement){
                   count = count + 1;
               }
               
               node[&quot;count&quot;] = count;               
               parsed.push(node);
           }
       }
       
        parsed.sort(function(a,b){return a.count &lt; b.count;});
        /** Parsing the metrics */    
        for(var i =0; i&lt; parsed.length; i++){
            if (parsed[i]){
                if (parsed[i].metrics){
                    parsed[i].metrics.sort(function(a,b){   
                        try{                                      
                            return  parseFloat(b._CC_of_partial_model) - parseFloat(a._CC_of_partial_model);
                        }
                        catch(e){                            
                            return false;
                        }
                    });
                }
            }
        }
        
        var html = &quot;&quot;;
       
        if (_this.PhasingStep_method == &quot;MR&quot;){
            
            dust.render(&quot;mr.mxdatacollectiongrid.template&quot;,  {parsed : parsed, hasScroll : _this.hasScroll}, function(err, out) {
                    html = html + out;
            });
        }
        else{
            
            dust.render(&quot;phasing.mxdatacollectiongrid.template&quot;,  {parsed : parsed, hasScroll : _this.hasScroll}, function(err, out) {
                    html = html + out;
            });
        }
        $(target).html(html);
    };
    var onError = function(sender, msg){
        $(target).html(&quot;Error retrieving data &quot; + msg);        
    };                    
                                    
    EXI.getDataAdapter({onSuccess : onSuccess, onError : onError}).mx.phasing.getPhasingViewByDataCollectionGroupId(this.dataCollectionGroupId);
}</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
