<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - mx/view/autoprocintegration/autoprocintegrationgrid.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>mx/view/autoprocintegration/autoprocintegrationgrid.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">105.60</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">280</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">45.70</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.86</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/**
* It shows information from the autoprocessing like cells (a,b,c,alpha,beta,gamma) and also about phasing
*
* @class AutoProcIntegrationGrid
* @constructor
*/
function AutoProcIntegrationGrid(args) {
	this.height = 500;
	this.tbar = false;
	this.id = BUI.id();
	
	this.preventSelection = false;
	this.maxHeight = 500;
	this.minHeight = 500;
    this.minHeight = 500;
      
    this.collapsed = true;
	if (args != null) {
		if (args.height != null) {
			this.height = args.height;
		}
        
		if (args.maxHeight != null) {
			this.maxHeight = args.maxHeight;
		}
		if (args.searchBar != null) {
			this.searchBar = args.searchBar;
		}

		if (args.tbar != null) {
			this.tbar = args.tbar;
		}

		if (args.collapsed != null) {
			this.collapsed = args.collapsed;
		}

		if (args.width != null) {
			this.width = args.width;
		}              
	}	
	this.onSelected = new Event(this);
}

AutoProcIntegrationGrid.prototype.parseData = function(data) {    
     /** Adding stats */     
    for(var i = 0; i &lt; data.length; i++){
         try{             
            data[i].statistics = this.getStatistics(data[i]);
            data[i].collapsed = this.getCollapseStatistics(data[i]);
            data[i].phasing = this.getPhasing(data[i]);              
            if (data[i].v_datacollection_summary_phasing_autoProcProgramId){                
                var fileName = data[i].DataCollection_imagePrefix;                         
                if (data[i].v_datacollection_summary_phasing_anomalous){
                    fileName = fileName +  &quot;_anomalous&quot;;
                }
                if (data[i].v_datacollection_summary_phasing_autoproc_space_group){
                    fileName = fileName +  &quot;_&quot; + data[i].v_datacollection_summary_phasing_autoproc_space_group.replace(/\s+/g, &#039;&#039;);
                }
                fileName = fileName + &quot;_&quot; +  data[i].v_datacollection_processingPrograms + &quot;.zip&quot;; 
                data[i].downloadFilesUrl = EXI.getDataAdapter().mx.autoproc.downloadAttachmentListByautoProcProgramsIdList(data[i].v_datacollection_summary_phasing_autoProcProgramId, fileName);
            }                                             
         }       
         catch(e){             
             console.log(e);
         }  
    }
    
    var anomalous = _.filter(data, function(o) { return (o.v_datacollection_summary_phasing_anomalous &amp;&amp; (o.v_datacollection_processingStatus == &quot;SUCCESS&quot; || (o.v_datacollection_processingStatus == 1)))});    
    var nonanomalous = _.filter(data, function(o) { return (o.v_datacollection_summary_phasing_anomalous == false &amp;&amp; (o.v_datacollection_processingStatus == &quot;SUCCESS&quot; || (o.v_datacollection_processingStatus == 1 )))});
    var running = _.filter(data, function(o) { return o.v_datacollection_processingStatus == &quot;RUNNING&quot;;});
    var failed = _.filter(data, function(o) { return o.v_datacollection_processingStatus == &quot;FAILED&quot; || (o.v_datacollection_processingStatus == 0 ); });
   
    /**Set non anomalous first */
    anomalousdata = new AutoprocessingRanker().rank(anomalous, &quot;v_datacollection_summary_phasing_autoproc_space_group&quot;);    
    nonanomalousdata = new AutoprocessingRanker().rank(nonanomalous, &quot;v_datacollection_summary_phasing_autoproc_space_group&quot;);    

    // https://github.com/ispyb/EXI/issues/204    
    return _.concat(nonanomalousdata, anomalousdata, running,failed);
    
};

AutoProcIntegrationGrid.prototype.load = function(data) {      
    this.data =this.parseData(data);
       
    if (this.collapsed){   
        this.loadCollapsed(this.data);
    }
    else{
	    this.store.loadData(this.data, false);
    }
};

AutoProcIntegrationGrid.prototype.loadCollapsed = function(data) {
	this.store.loadData([{ collapsed : true, items : data}], false);
};
/*
AutoProcIntegrationGrid.prototype.selectRowByAutoProcIntegrationId = function(autoProcIntegrationId) {
	this.preventSelection = true;debugger
	this.panel.getSelectionModel().select(this.store.find(&quot;v_datacollection_summary_phasing_autoProcIntegrationId&quot;, autoProcIntegrationId));
};
*/
AutoProcIntegrationGrid.prototype.getPhasing = function(data) {      
    var phasing = [];
    
    if (data.spaceGroupShortName){        
        var spaceGroups = data.spaceGroupShortName.split(&#039;,&#039;);
        var steps = data.phasingStepType.split(&#039;PREPARE&#039;);        
        for(var i = 0; i &lt; spaceGroups.length; i++){            
            phasing.push({
                spaceGroup              : spaceGroups[i],
                prepare                 : true,
                sub                     : steps[i+1].indexOf(&quot;SUBSTRUCTUREDETERMINATION&quot;) != -1,
                phasing                 : steps[i+1].indexOf(&quot;PHASING&quot;) != -1,
                model                   : steps[i+1].indexOf(&quot;MODEL&quot;) != -1,
                autoProcIntegrationId   : data.v_datacollection_summary_phasing_autoProcIntegrationId
            });
        }
        
        
    }
    return phasing;
};                 

AutoProcIntegrationGrid.prototype.getCollapseStatistics = function(data) {	  
    if (data.scalingStatisticsType) {                   
        var type = data.scalingStatisticsType.split(&quot;,&quot;);
    } else {
        var type = [];
    }
    function getValue(attribute, i, decimals){
        
        if (attribute){
            var splitted = attribute.split(&quot;,&quot;);
            if (splitted[i]){
                if (decimals){
                    try{ 
                        return Number( splitted[i]).toFixed(decimals)
                    }
                    catch(e){
                        return &quot;NaN&quot;;
                    }
                }
                return splitted[i];
            }
        }
        return &quot;&quot;;        
     }      
    
     for (var i = 0; i &lt; type.length; i++) {
        if (type[i]){           
                data[type[i]] = {
                                            type 					: type[i],
                                            resolutionLimitLow 		: getValue(data.resolutionLimitLow, i,1),
                                            resolutionLimitHigh 	: getValue(data.resolutionLimitHigh, i,1),
                                            multiplicity 			: getValue(data.multiplicity, i, 1),
                                            meanIOverSigI 			: getValue(data.meanIOverSigI, i, 1),
                                            completeness 			: getValue(data.completeness, i, 1),
                                            rMerge 			        : getValue(data.rMerge, i, 1),
                                            ccHalf 			        : getValue(data.ccHalf, i,1),
                                            rPimWithinIPlusIMinus 	: getValue(data.rPimWithinIPlusIMinus, i,1),
                                            rMeasAllIPlusIMinus 	: getValue(data.rMeasAllIPlusIMinus, i,1),
                                            ccAno                	: getValue(data.ccAno, i),
                                            sigAno                	: getValue(data.sigAno, i)
                                           
                                            
               };            
        }       
    }        
    return data;    				
};


AutoProcIntegrationGrid.prototype.getStatistics = function(data) {	 
    if (data.scalingStatisticsType) {                   
        var type = data.scalingStatisticsType.split(&quot;,&quot;);
    } else {
        var type = [];
    }
    function getValue(attribute, i, decimals){        
        if (attribute){
            var splitted = attribute.split(&quot;,&quot;);
            if (splitted[i]){
                if (decimals){
                    try{ 
                        return Number( splitted[i]).toFixed(decimals)
                    }
                    catch(e){
                        return &quot;NaN&quot;;
                    }
                }
                return splitted[i];
            }
        }
        return &quot;&quot;;        
    }
    
    var parsed = [];
    for (var i = 0; i &lt; type.length; i++) {       
        parsed.push({
            type 					: type[i],
            resolutionLimitLow 		: getValue(data.resolutionLimitLow, i),
            resolutionLimitHigh 	: getValue(data.resolutionLimitHigh, i),
            multiplicity 			: getValue(data.multiplicity, i),
            meanIOverSigI 			: getValue(data.meanIOverSigI, i),
            completeness 			: getValue(data.completeness, i),
            rMerge 			        : getValue(data.rMerge, i),
            ccHalf 			        : getValue(data.ccHalf, i),
            rPimWithinIPlusIMinus 	: getValue(data.rPimWithinIPlusIMinus, i),
            rMeasAllIPlusIMinus 	: getValue(data.rMeasAllIPlusIMinus, i),
            ccAno                	: getValue(data.ccAno, i),
            sigAno                	: getValue(data.sigAno, i)
            
        });
        
    }
            
    return parsed;    				
};

AutoProcIntegrationGrid.prototype.getPanel = function() {
	var _this = this;
    
	this.store = Ext.create(&#039;Ext.data.Store&#039;, {
		
		fields : [ &#039;autoProcId&#039;,
		           &#039;refinedCellA&#039;, 
                   &#039;v_datacollection_summary_phasing_autoProcIntegrationId&#039;,
		           &#039;autoProcIntegrationId&#039;,
		           &#039;v_datacollection_summary_phasing_anomalous&#039;,
		           &#039;v_datacollection_summary_phasing_processingPrograms&#039;,
		           &#039;v_datacollection_summary_phasing_autoproc_space_group&#039;]
	});
  
	
	this.panel = Ext.create(&#039;Ext.grid.Panel&#039;, {		
		store : this.store,		
        //tbar: this.getToolBar(),
        margin : 10,
		//cls : &#039;border-grid&#039;,
        // height : this.height,
        layout : &#039;fit&#039;,
		columns : [             
                    {
                        text : &#039;autoProcIntegrationId&#039;,
                        dataIndex : &#039;processingPrograms&#039;,
                        flex : 1,
                        hidden : true,
                        renderer : function(e, sample, record){
                            return record.data.v_datacollection_summary_phasing_autoProcIntegrationId;
                        }
                    },        
                    {
                        dataIndex: &#039;dataCollectionGroup&#039;,
                        name: &#039;dataCollectionGroup&#039;,
                        flex: 1.5,
                        hidden: false,
                        renderer: function(grid, e, record) {                            
                            var data = record.data;                            
                            var html = &quot;&quot;;        
                                                                                          
                            if (_this.collapsed){              
                                dust.render(&quot;collapsed.autoprocintegrationgrid.template&quot;, data.items, function(err, out) {
                                    html = html + out;
                                
                                });
                            }
                            else{
                                dust.render(&quot;autoprocintegrationgrid.template&quot;, data, function(err, out) {
                                    html = html + out;
                                
                                });
                            }
                            return html;
                        }
                    }                        		
		],
		flex : 1,
          viewConfig : {
                preserveScrollOnRefresh : true,
                stripeRows              : false,                
	    	}
	});
  
	return this.panel;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
